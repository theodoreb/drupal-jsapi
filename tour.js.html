<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: modules/tour/js/tour.js — Drupal JS API</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="pure/pure.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <!--<link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">-->
    <link type="text/css" rel="stylesheet" href="styles/drupal.css">
</head>

<body>

<div id="main" class="pure">

  <div class="pure-g">

    <div class="pure-u-4-5">
      <div class="box">
        <h1 class="page-title">Source: modules/tour/js/tour.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * @file
 * Attaches behaviors for the Tour module's toolbar tab.
 */

(function ($, Backbone, Drupal, document) {

"use strict";

var queryString = decodeURI(window.location.search);

/**
 * Attaches the tour's toolbar tab behavior.
 *
 * It uses the query string for:
 *
 * - tour: When ?tour=1 is present, the tour will start automatically
 *         after the page has loaded.
 * - tips: Pass ?tips=class in the url to filter the available tips to
 *         the subset which match the given class.
 *
 * Example:
 *   http://example.com/foo?tour=1&amp;tips=bar
 * @type {Behavior}
 */
Drupal.behaviors.tour = {
  attach: function (context) {
    $('body').once('tour', function (index, element) {
      var model = new Drupal.tour.models.StateModel();
      new Drupal.tour.views.ToggleTourView({
        el: $(context).find('#toolbar-tab-tour'),
        model: model
      });

      model
        // Allow other scripts to respond to tour events.
        .on('change:isActive', function (model, isActive) {
          $(document).trigger((isActive) ? 'drupalTourStarted' : 'drupalTourStopped');
        })
        // Initialization: check whether a tour is available on the current page.
        .set('tour', $(context).find('ol#tour'));

      // Start the tour immediately if toggled via query string.
      if (/tour=?/i.test(queryString)) {
        model.set('isActive', true);
      }

    });
  }
};

/**
 * @namespace
 */
Drupal.tour = {
  /**
   * @namespace
   */
  models: {},
  /**
   * @namespace
   */
  views: {}
};

/**
 * Backbone Model for tours.
 * @class
 */
Drupal.tour.models.StateModel = Backbone.Model.extend(/** @lends Drupal.tour.models.StateModel# */ {
  /**
   * @type {Object}
   * @prop {Array} tour
   * @prop {Boolean} isActive
   * @prop {Array} activeTour
   */
  defaults: {
    // Indicates whether the Drupal root window has a tour.
    tour: [],
    // Indicates whether the tour is currently running.
    isActive: false,
    // Indicates which tour is the active one (necessary to cleanly stop).
    activeTour: []
  }
});

/**
 * Handles edit mode toggle interactions.
 * @class
 */
Drupal.tour.views.ToggleTourView = Backbone.View.extend(/** @lends Drupal.tour.views.ToggleTourView# */ {

  events: { 'click': 'onClick' },

  initialize: function () {
    this.model.on('change:tour change:isActive', this.render, this);
    this.model.on('change:isActive', this.toggleTour, this);
  },

  /**
   * Implements Backbone Views' render().
   * return {Drupal.tour.views.ToggleTourView}
   */
  render: function () {
    // Render the visibility.
    this.$el.toggleClass('hidden', this._getTour().length === 0);
    // Render the state.
    var isActive = this.model.get('isActive');
    this.$el.find('button')
      .toggleClass('active', isActive)
      .prop('aria-pressed', isActive);
    return this;
  },

  /**
   * Model change handler; starts or stops the tour.
   */
  toggleTour: function() {
    if (this.model.get('isActive')) {
      var $tour = this._getTour();
      this._removeIrrelevantTourItems($tour, this._getDocument());
      var that = this;
      if ($tour.find('li').length) {
        $tour.joyride({
          postRideCallback: function () { that.model.set('isActive', false); }
        });
        this.model.set({ isActive: true, activeTour: $tour });
      }
    }
    else {
      this.model.get('activeTour').joyride('destroy');
      this.model.set({ isActive: false, activeTour: [] });
    }
  },

  /**
   * Toolbar tab click event handler; toggles isActive.
   */
  onClick: function (event) {
    this.model.set('isActive', !this.model.get('isActive'));
    event.preventDefault();
    event.stopPropagation();
  },

  /**
   * Gets the tour.
   *
   * @return {jQueryObject}
   *   A jQuery element pointing to a &lt;ol> containing tour items.
   */
  _getTour: function () {
    return this.model.get('tour');
  },

  /**
   * Gets the relevant document as a jQuery element.
   *
   * @return {jQueryObject}
   *   A jQuery element pointing to the document within which a tour would be
   *   started given the current state.
   */
  _getDocument: function () {
    return $(document);
  },

  /**
   * Removes tour items for elements that don't have matching page elements or
   * are explicitly filtered out via the 'tips' query string.
   *
   * Example:
   *   http://example.com/foo?tips=bar
   *
   *   The above will filter out tips that do not have a matching page element or
   *   don't have the "bar" class.
   *
   * @param {jQueryObject} $tour
   *   A jQuery element pointing to a &lt;ol> containing tour items.
   * @param {jQueryObject} $document
   *   A jQuery element pointing to the document within which the elements
   *   should be sought.
   *
   * @see _getDocument
   */
  _removeIrrelevantTourItems: function ($tour, $document) {
    var removals = false;
    var tips = /tips=([^&amp;]+)/.exec(queryString);
    $tour
      .find('li')
      .each(function () {
        var $this = $(this);
        var itemId = $this.attr('data-id');
        var itemClass = $this.attr('data-class');
        // If the query parameter 'tips' is set, remove all tips that don't
        // have the matching class.
        if (tips &amp;&amp; !$(this).hasClass(tips[1])) {
          removals = true;
          $this.remove();
          return;
        }
        // Remove tip from the DOM if there is no corresponding page element.
        if ((!itemId &amp;&amp; !itemClass) ||
            (itemId &amp;&amp; $document.find('#' + itemId).length) ||
           (itemClass &amp;&amp; $document.find('.' + itemClass).length)){
          return;
        }
        removals = true;
        $this.remove();
      });

    // If there were removals, we'll have to do some clean-up.
    if (removals) {
      var total = $tour.find('li').length;
      if (!total) {
        this.model.set({ tour: [] });
      }

      $tour
        .find('li')
        // Rebuild the progress data.
        .each(function (index) {
          var progress = Drupal.t('!tour_item of !total', { '!tour_item': index + 1, '!total': total });
          $(this).find('.tour-progress').text(progress);
        })
        // Update the last item to have "End tour" as the button.
        .last()
        .attr('data-text', Drupal.t('End tour'));
    }
  }

});

})(jQuery, Backbone, Drupal, document);
</code></pre>
        </article>
    </section>




      </div>
    </div>

    <nav class="pure-u-1-5">
      <div class="box"><h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="Drupal.ajax.html">Drupal.ajax</a></li><li><a href="Drupal.AjaxCommands.html">Drupal.AjaxCommands</a></li><li><a href="Drupal.AjaxError.html">Drupal.AjaxError</a></li><li><a href="Drupal.CollapsibleDetails.html">Drupal.CollapsibleDetails</a></li><li><a href="Drupal.contextual.AuralView.html">Drupal.contextual.AuralView</a></li><li><a href="Drupal.contextual.KeyboardView.html">Drupal.contextual.KeyboardView</a></li><li><a href="Drupal.contextual.Model.html">Drupal.contextual.Model</a></li><li><a href="Drupal.contextual.RegionView.html">Drupal.contextual.RegionView</a></li><li><a href="Drupal.contextual.VisualView.html">Drupal.contextual.VisualView</a></li><li><a href="Drupal.contextualToolbar.html#Model">Drupal.contextualToolbar.Model</a></li><li><a href="Drupal.contextualToolbar.html#VisualView">Drupal.contextualToolbar.VisualView</a></li><li><a href="Drupal.DropButton.html">Drupal.DropButton</a></li><li><a href="Drupal.edit.AppModel.html">Drupal.edit.AppModel</a></li><li><a href="Drupal.edit.AppView.html">Drupal.edit.AppView</a></li><li><a href="Drupal.edit.ContextualLinkView.html">Drupal.edit.ContextualLinkView</a></li><li><a href="Drupal.edit.EditorModel.html">Drupal.edit.EditorModel</a></li><li><a href="Drupal.edit.editors.editor.html">Drupal.edit.editors.editor</a></li><li><a href="Drupal.edit.editors.form.html">Drupal.edit.editors.form</a></li><li><a href="Drupal.edit.editors.plain_text.html">Drupal.edit.editors.plain_text</a></li><li><a href="Drupal.edit.EditorView.html">Drupal.edit.EditorView</a></li><li><a href="Drupal.edit.EntityCollection.html">Drupal.edit.EntityCollection</a></li><li><a href="Drupal.edit.EntityDecorationView.html">Drupal.edit.EntityDecorationView</a></li><li><a href="Drupal.edit.EntityModel.html">Drupal.edit.EntityModel</a></li><li><a href="Drupal.edit.EntityToolbarView.html">Drupal.edit.EntityToolbarView</a></li><li><a href="Drupal.edit.FieldCollection.html">Drupal.edit.FieldCollection</a></li><li><a href="Drupal.edit.FieldDecorationView.html">Drupal.edit.FieldDecorationView</a></li><li><a href="Drupal.edit.FieldModel.html">Drupal.edit.FieldModel</a></li><li><a href="Drupal.edit.FieldToolbarView.html">Drupal.edit.FieldToolbarView</a></li><li><a href="Drupal.EditorFeature.html">Drupal.EditorFeature</a></li><li><a href="Drupal.EditorFeatureHTMLRule.html">Drupal.EditorFeatureHTMLRule</a></li><li><a href="Drupal.fieldUIDisplayOverview.field.html">Drupal.fieldUIDisplayOverview.field</a></li><li><a href="Drupal.FilterHTMLRule.html">Drupal.FilterHTMLRule</a></li><li><a href="Drupal.FilterStatus.html">Drupal.FilterStatus</a></li><li><a href="Drupal.ProgressBar.html">Drupal.ProgressBar</a></li><li><a href="Drupal.states.Dependent.html">Drupal.states.Dependent</a></li><li><a href="Drupal.states.State.html">Drupal.states.State</a></li><li><a href="Drupal.states.Trigger.html">Drupal.states.Trigger</a></li><li><a href="Drupal.tableDrag.html">Drupal.tableDrag</a></li><li><a href="Drupal.TableHeader.html">Drupal.TableHeader</a></li><li><a href="Drupal.TableResponsive.html">Drupal.TableResponsive</a></li><li><a href="Drupal.toolbar.BodyVisualView.html">Drupal.toolbar.BodyVisualView</a></li><li><a href="Drupal.toolbar.MenuModel.html">Drupal.toolbar.MenuModel</a></li><li><a href="Drupal.toolbar.MenuVisualView.html">Drupal.toolbar.MenuVisualView</a></li><li><a href="Drupal.toolbar.ToolbarAuralView.html">Drupal.toolbar.ToolbarAuralView</a></li><li><a href="Drupal.toolbar.ToolbarModel.html">Drupal.toolbar.ToolbarModel</a></li><li><a href="Drupal.toolbar.ToolbarVisualView.html">Drupal.toolbar.ToolbarVisualView</a></li><li><a href="Drupal.tour.models.StateModel.html">Drupal.tour.models.StateModel</a></li><li><a href="Drupal.tour.views.ToggleTourView.html">Drupal.tour.views.ToggleTourView</a></li><li><a href="Drupal.verticalTab.html">Drupal.verticalTab</a></li><li><a href="Drupal.views.ajaxView.html">Drupal.views.ajaxView</a></li><li><a href="Drupal.viewsUi.AddItemForm.html">Drupal.viewsUi.AddItemForm</a></li><li><a href="Drupal.viewsUi.Checkboxifier.html">Drupal.viewsUi.Checkboxifier</a></li><li><a href="Drupal.viewsUi.FormFieldFiller.html">Drupal.viewsUi.FormFieldFiller</a></li><li><a href="Drupal.viewsUi.OptionsSearch.html">Drupal.viewsUi.OptionsSearch</a></li><li><a href="Drupal.viewsUi.RearrangeFilterHandler.html">Drupal.viewsUi.RearrangeFilterHandler</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:drupalViewportOffsetChange">event:drupalViewportOffsetChange</a></li></ul><h3>Namespaces</h3><ul><li><a href="Drupal.html" class="root">Drupal</a></li><li><a href="Drupal.behaviors.html">Drupal.behaviors</a></li><li><a href="Drupal.color.html">Drupal.color</a></li><li><a href="Drupal.contextual.html">Drupal.contextual</a></li><li><a href="Drupal.contextualToolbar.html">Drupal.contextualToolbar</a></li><li><a href="Drupal.edit.html">Drupal.edit</a></li><li><a href="Drupal.edit.metadata.html">Drupal.edit.metadata</a></li><li><a href="Drupal.edit.util.html">Drupal.edit.util</a></li><li><a href="Drupal.edit.util.constants.html">Drupal.edit.util.constants</a></li><li><a href="Drupal.edit.util.form.html">Drupal.edit.util.form</a></li><li><a href="Drupal.editorConfiguration.html">Drupal.editorConfiguration</a></li><li><a href="Drupal.editors.html">Drupal.editors</a></li><li><a href="Drupal.fieldUIDisplayOverview.html">Drupal.fieldUIDisplayOverview</a></li><li><a href="Drupal.fieldUIOverview.html">Drupal.fieldUIOverview</a></li><li><a href="Drupal.file.html">Drupal.file</a></li><li><a href="Drupal.filterConfiguration.html">Drupal.filterConfiguration</a></li><li><a href="Drupal.filterConfiguration.liveSettingParsers.html">Drupal.filterConfiguration.liveSettingParsers</a></li><li><a href="Drupal.history.html">Drupal.history</a></li><li><a href="Drupal.states.html">Drupal.states</a></li><li><a href="Drupal.states.Trigger.states.html">Drupal.states.Trigger.states</a></li><li><a href="Drupal.theme.html">Drupal.theme</a></li><li><a href="Drupal.toolbar.html">Drupal.toolbar</a></li><li><a href="Drupal.tour.html">Drupal.tour</a></li><li><a href="Drupal.tour.models.html">Drupal.tour.models</a></li><li><a href="Drupal.tour.views.html">Drupal.tour.views</a></li><li><a href="Drupal.Views.html">Drupal.Views</a></li><li><a href="Drupal.views_.html">Drupal.views</a></li><li><a href="Drupal.viewsUi.html">Drupal.viewsUi</a></li></ul><h3>Global</h3><ul><li><a href="global.html#drupalSettings" class="root">drupalSettings</a></li><li><a href="global.html#matchMedia" class="root">matchMedia</a></li></ul></div>
    </nav>
  </div>

</div>


<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
