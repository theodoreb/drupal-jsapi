<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="generator" content="HTML Tidy for Linux (vers 25 March 2009), see www.w3.org">
    <meta charset="utf-8">
    <title>
      Source: modules/ckeditor/js/plugins/drupalimagecaption/plugin.js — Drupal JS API
    </title>
    <script src="scripts/prettify/prettify.js" type="text/javascript">
</script>
    <script src="scripts/prettify/lang-css.js" type="text/javascript">
</script>
    <link type="text/css" rel="stylesheet" href="pure/pure.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/drupal.css">
  </head>
  <body>
    <div id="main" class="pure">
      <div class="pure-g">
        <div class="pure-u-4-5">
          <div class="box">
            <h1 class="page-title">
              Source: modules/ckeditor/js/plugins/drupalimagecaption/plugin.js
            </h1>
            <section>
              <article>
                <pre class="prettyprint source">
<code>/**
 * @file
 * Drupal Image Caption plugin.
 *
 * Integrates the Drupal Image plugin with the caption_filter filter if enabled.
 */

(function (CKEDITOR) {

"use strict";

CKEDITOR.plugins.add('drupalimagecaption', {
  requires: 'widget',
  init: function (editor) {

    /**
     * Override drupalimage plugin's image insertion mechanism with our own, to
     * ensure a widget is inserted, rather than a simple image (Widget's auto-
     * discovery only runs upon init).
     */
    editor.on('drupalimageinsert', function (event) {
      editor.execCommand('widgetDrupalimagecaption');
      event.cancel();
    });

    // Register the widget with a unique name "drupalimagecaption".
    editor.widgets.add('drupalimagecaption', {
      allowedContent: 'img[!src,alt,width,height,!data-caption,!data-align]',
      template: '&lt;img src="" /&gt;',
      parts: {
        image: 'img'
      },

      // Initialization method called for every widget instance being
      // upcasted.
      init: function () {
        var image = this.parts.image;

        // Save the initial widget data.
        this.setData({
          'data-editor-file-uuid': image.getAttribute('data-editor-file-uuid'),
          src: image.getAttribute('src'),
          width: image.getAttribute('width') || '',
          height: image.getAttribute('height') || '',
          alt: image.getAttribute('alt') || '',
          data_caption: image.getAttribute('data-caption'),
          data_align: image.getAttribute('data-align'),
          hasCaption: image.hasAttribute('data-caption')
        });

        image.removeStyle('float');
      },

      // Called after initialization and on "data" changes.
      data: function () {
        if (this.data['data-editor-file-uuid'] !== null) {
          this.parts.image.setAttribute('data-editor-file-uuid', this.data['data-editor-file-uuid']);
          this.parts.image.setAttribute('data-cke-saved-data-editor-file-uuid', this.data['data-editor-file-uuid']);
        }
        this.parts.image.setAttribute('src', this.data.src);
        this.parts.image.setAttribute('data-cke-saved-src', this.data.src);
        this.parts.image.setAttribute('alt', this.data.alt);
        this.parts.image.setAttribute('data-cke-saved-alt', this.data.alt);
        this.parts.image.setAttribute('width', this.data.width);
        this.parts.image.setAttribute('data-cke-saved-width', this.data.width);
        this.parts.image.setAttribute('height', this.data.height);
        this.parts.image.setAttribute('data-cke-saved-height', this.data.height);
        if (this.data.hasCaption) {
          this.parts.image.setAttribute('data-caption', this.data.data_caption);
          this.parts.image.setAttribute('data-cke-saved-data-caption', this.data.data_caption);
        }
        else {
          this.parts.image.removeAttributes(['data-caption', 'data-cke-saved-data-caption']);
        }
        if (this.data.data_align !== null) {
          this.parts.image.setAttribute('data-align', this.data.data_align);
          this.parts.image.setAttribute('data-cke-saved-data-align', this.data.data_align);
        }
        else {
          this.parts.image.removeAttributes(['data-align', 'data-cke-saved-data-align']);
        }

        // Float the wrapper too.
        if (this.data.data_align === null) {
          this.wrapper.removeStyle('float');
          this.wrapper.removeStyle('text-align');
        }
        else if (this.data.data_align === 'center') {
          this.wrapper.setStyle('float', 'none');
          this.wrapper.setStyle('text-align', 'center');
        }
        else {
          this.wrapper.setStyle('float', this.data.data_align);
          this.wrapper.removeStyle('text-align');
        }
      },

      // Check the elements that need to be converted to widgets.
      upcast: function (el) {
        // Upcast all &lt;img&gt; elements that are alone inside a block element.
        if (el.name === 'img') {
          if (CKEDITOR.dtd.$block[el.parent.name] &amp;&amp; el.parent.children.length === 1) {
            return true;
          }
        }
      },

      // Convert the element back to its desired output representation.
      downcast: function (el) {
        if (this.data.hasCaption) {
          el.attributes['data-caption'] = this.data.data_caption;
        }

        if (this.data.data_align) {
          el.attributes['data-align'] = this.data.data_align;
        }

        if (!this.data.width) {
          el.attributes['data-cke-saved-width'] = this.parts.image.$.naturalWidth;
        }
        if (!this.data.height) {
          el.attributes['data-cke-saved-height'] = this.parts.image.$.naturalHeight;
        }
      },

      _selectionWillCreateInlineImage: function () {
        // Returns node or first of its ancestors
        // which is a block or block limit.
        function getBlockParent( node, root ) {
          var path = new CKEDITOR.dom.elementPath( node, root );
          return path.block || path.blockLimit;
        }

        var range = editor.getSelection().getRanges()[ 0 ],
          startEl = getBlockParent( range.startContainer, range.root ),
          endEl = getBlockParent( range.endContainer, range.root );

        var insideStartEl = range.checkBoundaryOfElement( startEl, CKEDITOR.START );
        var insideEndEl = range.checkBoundaryOfElement( endEl, CKEDITOR.END );

        return !(insideStartEl &amp;&amp; insideEndEl);
      },

      _insertSaveCallback: function (returnValues) {
        // We can't create an image with an empty "src" attribute.
        if (returnValues.attributes.src.length === 0) {
          return;
        }

        editor.fire('saveSnapshot');

        // Build the HTML for the widget.
        var html = '&lt;img ';
        for (var attr in returnValues.attributes) {
          if (returnValues.attributes.hasOwnProperty(attr) &amp;&amp; !attr.match(/^data_/)) {
            html += attr + '="' + returnValues.attributes[attr] + '" ';
            html += 'data-cke-saved-' + attr + '="' + returnValues.attributes[attr] + '" ';
          }
        }
        if (returnValues.hasCaption) {
          html += 'data-caption="" ';
          html += ' data-cke-saved-data-caption=""';
        }
        if (returnValues.attributes.data_align &amp;&amp; returnValues.attributes.data_align !== 'none') {
          html += 'data-align="' + returnValues.attributes.data_align + '" ';
          html += ' data-cke-saved-data-align="' + returnValues.attributes.data_align + '"';
        }
        html += ' /&gt;';
        var el = new CKEDITOR.dom.element.createFromHtml(html, editor.document);
        editor.insertElement(editor.widgets.wrapElement(el, 'drupalimagecaption'));

        // Save snapshot for undo support.
        editor.fire('saveSnapshot');

        // Initialize and focus the widget.
        var widget = editor.widgets.initOn(el, 'drupalimagecaption');
        widget.focus();
      },

      insert: function () {
        var override = {
          imageDOMElement: null,
          existingValues: { hasCaption: false, data_align: '' },
          saveCallback: this._insertSaveCallback,
          dialogTitle: editor.config.drupalImage_dialogTitleAdd
        };
        if (this._selectionWillCreateInlineImage()) {
          override.existingValues.isInline = this._selectionWillCreateInlineImage();
          delete override.saveCallback;
        }
        editor.execCommand('drupalimage', override);
      },

      edit: function () {
        var that = this;
        var saveCallback = function (returnValues) {
          editor.fire('saveSnapshot');
          // Set the updated widget data.
          that.setData({
            'data-editor-file-uuid': returnValues.attributes['data-editor-file-uuid'],
            src: returnValues.attributes.src,
            width: returnValues.attributes.width,
            height: returnValues.attributes.height,
            alt: returnValues.attributes.alt,
            hasCaption: !!returnValues.hasCaption,
            data_caption: returnValues.hasCaption ? that.data.data_caption : '',
            data_align: returnValues.attributes.data_align === 'none' ? null : returnValues.attributes.data_align
          });
          // Save snapshot for undo support.
          editor.fire('saveSnapshot');
        };
        var override = {
          imageDOMElement: this.parts.image.$,
          existingValues: this.data,
          saveCallback: saveCallback,
          dialogTitle: this.data.src === '' ? editor.config.drupalImage_dialogTitleAdd : editor.config.drupalImage_dialogTitleEdit
        };
        editor.execCommand('drupalimage', override);
      }
    });
  },

  afterInit: function (editor) {
    function setupAlignCommand (value) {
      var command = editor.getCommand('justify' + value);
      if (command) {
        if (value in { right: 1, left: 1, center: 1 }) {
          command.on('exec', function (event) {
            var widget = getSelectedWidget(editor);
            if (widget &amp;&amp; widget.name === 'drupalimagecaption') {
              widget.setData({ data_align: value });
              event.cancel();
            }
          });
        }

        command.on('refresh', function (event) {
          var widget = getSelectedWidget(editor),
            allowed = { left: 1, center: 1, right: 1 },
            align;

          if (widget) {
            align = widget.data.data_align;

            this.setState(
              (align === value) ? CKEDITOR.TRISTATE_ON : (value in allowed) ? CKEDITOR.TRISTATE_OFF : CKEDITOR.TRISTATE_DISABLED);

            event.cancel();
          }
        });
      }
    }

    function getSelectedWidget (editor) {
      var widget = editor.widgets.focused;
      if (widget &amp;&amp; widget.name === 'drupalimagecaption') {
        return widget;
      }
      return null;
    }

    // Customize the behavior of the alignment commands.
    setupAlignCommand('left');
    setupAlignCommand('right');
    setupAlignCommand('center');
  }
});

})(CKEDITOR);
</code>
</pre>
              </article>
            </section>
          </div>
        </div>
        <nav class="pure-u-1-5">
          <div class="box">
            <h2>
              <a href="index.html">Index</a>
            </h2>
            <h3>
              Classes
            </h3>
            <ul>
              <li>
                <a href="Drupal.ajax.html">Drupal.ajax</a>
              </li>
              <li>
                <a href="Drupal.AjaxCommands.html">Drupal.AjaxCommands</a>
              </li>
              <li>
                <a href="Drupal.AjaxError.html">Drupal.AjaxError</a>
              </li>
              <li>
                <a href="Drupal.CollapsibleDetails.html">Drupal.CollapsibleDetails</a>
              </li>
              <li>
                <a href="Drupal.contextual.AuralView.html">Drupal.contextual.AuralView</a>
              </li>
              <li>
                <a href="Drupal.contextual.KeyboardView.html">Drupal.contextual.KeyboardView</a>
              </li>
              <li>
                <a href="Drupal.contextual.RegionView.html">Drupal.contextual.RegionView</a>
              </li>
              <li>
                <a href="Drupal.contextual.StateModel.html">Drupal.contextual.StateModel</a>
              </li>
              <li>
                <a href="Drupal.contextual.VisualView.html">Drupal.contextual.VisualView</a>
              </li>
              <li>
                <a href="Drupal.contextualToolbar.Model.html">Drupal.contextualToolbar.Model</a>
              </li>
              <li>
                <a href="Drupal.contextualToolbar.VisualView.html">Drupal.contextualToolbar.VisualView</a>
              </li>
              <li>
                <a href="Drupal.DropButton.html">Drupal.DropButton</a>
              </li>
              <li>
                <a href="Drupal.edit.AppModel.html">Drupal.edit.AppModel</a>
              </li>
              <li>
                <a href="Drupal.edit.AppView.html">Drupal.edit.AppView</a>
              </li>
              <li>
                <a href="Drupal.edit.BaseModel.html">Drupal.edit.BaseModel</a>
              </li>
              <li>
                <a href="Drupal.edit.ContextualLinkView.html">Drupal.edit.ContextualLinkView</a>
              </li>
              <li>
                <a href="Drupal.edit.EditorModel.html">Drupal.edit.EditorModel</a>
              </li>
              <li>
                <a href="Drupal.edit.editors.editor.html">Drupal.edit.editors.editor</a>
              </li>
              <li>
                <a href="Drupal.edit.editors.form.html">Drupal.edit.editors.form</a>
              </li>
              <li>
                <a href="Drupal.edit.editors.plain_text.html">Drupal.edit.editors.plain_text</a>
              </li>
              <li>
                <a href="Drupal.edit.EditorView.html">Drupal.edit.EditorView</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityCollection.html">Drupal.edit.EntityCollection</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityDecorationView.html">Drupal.edit.EntityDecorationView</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityModel.html">Drupal.edit.EntityModel</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityToolbarView.html">Drupal.edit.EntityToolbarView</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldCollection.html">Drupal.edit.FieldCollection</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldDecorationView.html">Drupal.edit.FieldDecorationView</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldModel.html">Drupal.edit.FieldModel</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldToolbarView.html">Drupal.edit.FieldToolbarView</a>
              </li>
              <li>
                <a href="Drupal.EditorFeature.html">Drupal.EditorFeature</a>
              </li>
              <li>
                <a href="Drupal.EditorFeatureHTMLRule.html">Drupal.EditorFeatureHTMLRule</a>
              </li>
              <li>
                <a href="Drupal.fieldUIDisplayOverview.field.html">Drupal.fieldUIDisplayOverview.field</a>
              </li>
              <li>
                <a href="Drupal.FilterHTMLRule.html">Drupal.FilterHTMLRule</a>
              </li>
              <li>
                <a href="Drupal.FilterStatus.html">Drupal.FilterStatus</a>
              </li>
              <li>
                <a href="Drupal.ProgressBar.html">Drupal.ProgressBar</a>
              </li>
              <li>
                <a href="Drupal.states.Dependent.html">Drupal.states.Dependent</a>
              </li>
              <li>
                <a href="Drupal.states.State.html">Drupal.states.State</a>
              </li>
              <li>
                <a href="Drupal.states.Trigger.html">Drupal.states.Trigger</a>
              </li>
              <li>
                <a href="Drupal.tableDrag.html">Drupal.tableDrag</a>
              </li>
              <li>
                <a href="Drupal.TableHeader.html">Drupal.TableHeader</a>
              </li>
              <li>
                <a href="Drupal.TableResponsive.html">Drupal.TableResponsive</a>
              </li>
              <li>
                <a href="Drupal.toolbar.BodyVisualView.html">Drupal.toolbar.BodyVisualView</a>
              </li>
              <li>
                <a href="Drupal.toolbar.MenuModel.html">Drupal.toolbar.MenuModel</a>
              </li>
              <li>
                <a href="Drupal.toolbar.MenuVisualView.html">Drupal.toolbar.MenuVisualView</a>
              </li>
              <li>
                <a href="Drupal.toolbar.ToolbarAuralView.html">Drupal.toolbar.ToolbarAuralView</a>
              </li>
              <li>
                <a href="Drupal.toolbar.ToolbarModel.html">Drupal.toolbar.ToolbarModel</a>
              </li>
              <li>
                <a href="Drupal.toolbar.ToolbarVisualView.html">Drupal.toolbar.ToolbarVisualView</a>
              </li>
              <li>
                <a href="Drupal.tour.models.StateModel.html">Drupal.tour.models.StateModel</a>
              </li>
              <li>
                <a href="Drupal.tour.views.ToggleTourView.html">Drupal.tour.views.ToggleTourView</a>
              </li>
              <li>
                <a href="Drupal.verticalTab.html">Drupal.verticalTab</a>
              </li>
              <li>
                <a href="Drupal.views.ajaxView.html">Drupal.views.ajaxView</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.AddItemForm.html">Drupal.viewsUi.AddItemForm</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.Checkboxifier.html">Drupal.viewsUi.Checkboxifier</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.FormFieldFiller.html">Drupal.viewsUi.FormFieldFiller</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.OptionsSearch.html">Drupal.viewsUi.OptionsSearch</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.RearrangeFilterHandler.html">Drupal.viewsUi.RearrangeFilterHandler</a>
              </li>
            </ul>
            <h3>
              Events
            </h3>
            <ul>
              <li>
                <a href="global.html#event:drupalViewportOffsetChange">event:drupalViewportOffsetChange</a>
              </li>
              <li>
                <a href="global.html#event:formUpdated">event:formUpdated</a>
              </li>
              <li>
                <a href="global.html#event:summaryUpdated">event:summaryUpdated</a>
              </li>
            </ul>
            <h3>
              Namespaces
            </h3>
            <ul>
              <li>
                <a href="Drupal.html" class="root">Drupal</a>
              </li>
              <li>
                <a href="Drupal.behaviors.html">Drupal.behaviors</a>
              </li>
              <li>
                <a href="Drupal.ckeditor.html">Drupal.ckeditor</a>
              </li>
              <li>
                <a href="Drupal.color.html">Drupal.color</a>
              </li>
              <li>
                <a href="Drupal.contextual.html">Drupal.contextual</a>
              </li>
              <li>
                <a href="Drupal.contextualToolbar.html">Drupal.contextualToolbar</a>
              </li>
              <li>
                <a href="Drupal.edit.html">Drupal.edit</a>
              </li>
              <li>
                <a href="Drupal.edit.metadata.html">Drupal.edit.metadata</a>
              </li>
              <li>
                <a href="Drupal.edit.util.html">Drupal.edit.util</a>
              </li>
              <li>
                <a href="Drupal.edit.util.constants.html">Drupal.edit.util.constants</a>
              </li>
              <li>
                <a href="Drupal.edit.util.form.html">Drupal.edit.util.form</a>
              </li>
              <li>
                <a href="Drupal.editorConfiguration.html">Drupal.editorConfiguration</a>
              </li>
              <li>
                <a href="Drupal.editors.html">Drupal.editors</a>
              </li>
              <li>
                <a href="Drupal.fieldUIDisplayOverview.html">Drupal.fieldUIDisplayOverview</a>
              </li>
              <li>
                <a href="Drupal.fieldUIOverview.html">Drupal.fieldUIOverview</a>
              </li>
              <li>
                <a href="Drupal.file.html">Drupal.file</a>
              </li>
              <li>
                <a href="Drupal.filterConfiguration.html">Drupal.filterConfiguration</a>
              </li>
              <li>
                <a href="Drupal.filterConfiguration.liveSettingParsers.html">Drupal.filterConfiguration.liveSettingParsers</a>
              </li>
              <li>
                <a href="Drupal.history.html">Drupal.history</a>
              </li>
              <li>
                <a href="Drupal.states.html">Drupal.states</a>
              </li>
              <li>
                <a href="Drupal.states.Trigger.states.html">Drupal.states.Trigger.states</a>
              </li>
              <li>
                <a href="Drupal.theme.html">Drupal.theme</a>
              </li>
              <li>
                <a href="Drupal.toolbar.html">Drupal.toolbar</a>
              </li>
              <li>
                <a href="Drupal.tour.html">Drupal.tour</a>
              </li>
              <li>
                <a href="Drupal.tour.models.html">Drupal.tour.models</a>
              </li>
              <li>
                <a href="Drupal.tour.views.html">Drupal.tour.views</a>
              </li>
              <li>
                <a href="Drupal.views.html">Drupal.views</a>
              </li>
              <li>
                <a href="Drupal.Views_.html">Drupal.Views</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.html">Drupal.viewsUi</a>
              </li>
            </ul>
            <h3>
              Global
            </h3>
            <ul>
              <li>
                <a href="global.html#drupalSettings" class="root">drupalSettings</a>
              </li>
              <li>
                <a href="global.html#matchMedia" class="root">matchMedia</a>
              </li>
            </ul>
            <p>
              <strong>For more information about this documentation please see <a href="https://drupal.org/node/2182153">Issue #2182153: Use JSDoc</a>.</strong>
            </p>
          </div>
        </nav>
      </div>
    </div><script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47079344-1', 'theodoreb.net');
    ga('send', 'pageview');
    </script><script type="text/javascript">
prettyPrint();
    </script><script src="scripts/linenumber.js" type="text/javascript">
</script>
  </body>
</html>
