<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="generator" content="HTML Tidy for Linux (vers 25 March 2009), see www.w3.org">
    <meta charset="utf-8">
    <title>
      Source: modules/ckeditor/js/plugins/drupallink/plugin.js — Drupal JS API
    </title>
    <script src="scripts/prettify/prettify.js" type="text/javascript">
</script>
    <script src="scripts/prettify/lang-css.js" type="text/javascript">
</script>
    <link type="text/css" rel="stylesheet" href="pure/pure.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/drupal.css">
  </head>
  <body>
    <div id="main" class="pure">
      <div class="pure-g">
        <div class="pure-u-4-5">
          <div class="box">
            <h1 class="page-title">
              Source: modules/ckeditor/js/plugins/drupallink/plugin.js
            </h1>
            <section>
              <article>
                <pre class="prettyprint source">
<code>/**
 * @file
 * Drupal Link plugin.
 */

(function ($, Drupal, drupalSettings, CKEDITOR) {

"use strict";

CKEDITOR.plugins.add('drupallink', {
  init: function (editor) {
    // Add the commands for link and unlink.
    editor.addCommand('drupallink', {
      allowedContent: 'a[!href,target]',
      requiredContent: 'a[href]',
      modes: { wysiwyg : 1 },
      canUndo: true,
      exec: function (editor) {
        var linkElement = getSelectedLink(editor);
        var linkDOMElement = null;

        // Set existing values based on selected element.
        var existingValues = {};
        if (linkElement &amp;&amp; linkElement.$) {
          linkDOMElement = linkElement.$;

          // Populate an array with the link's current attributes.
          var attribute = null, attributeName;
          for (var key = 0; key &lt; linkDOMElement.attributes.length; key++) {
            attribute = linkDOMElement.attributes.item(key);
            attributeName = attribute.nodeName.toLowerCase();
            // Don't consider data-cke-saved- attributes; they're just there to
            // work around browser quirks.
            if (attributeName.substring(0, 15) === 'data-cke-saved-') {
              continue;
            }
            // Store the value for this attribute, unless there's a
            // data-cke-saved- alternative for it, which will contain the quirk-
            // free, original value.
            existingValues[attributeName] = linkElement.data('cke-saved-' + attributeName) || attribute.nodeValue;
          }
        }

        // Prepare a save callback to be used upon saving the dialog.
        var saveCallback = function (returnValues) {
          editor.fire('saveSnapshot');

          // Create a new link element if needed.
          if (!linkElement &amp;&amp; returnValues.attributes.href) {
            var selection = editor.getSelection();
            var range = selection.getRanges(1)[0];

            // Use link URL as text with a collapsed cursor.
            if (range.collapsed) {
              // Shorten mailto URLs to just the e-mail address.
              var text = new CKEDITOR.dom.text(returnValues.attributes.href.replace(/^mailto:/, ''), editor.document);
              range.insertNode(text);
              range.selectNodeContents(text);
            }

            // Ignore a disabled target attribute.
            if (returnValues.attributes.target === 0) {
              delete returnValues.attributes.target;
            }

            // Create the new link by applying a style to the new text.
            var style = new CKEDITOR.style({ element: 'a', attributes: returnValues.attributes });
            style.type = CKEDITOR.STYLE_INLINE;
            style.applyToRange(range);
            range.select();

            // Set the link so individual properties may be set below.
            linkElement = getSelectedLink(editor);
          }
          // Update the link properties.
          else if (linkElement) {
            for (var key in returnValues.attributes) {
              if (returnValues.attributes.hasOwnProperty(key)) {
                // Update the property if a value is specified.
                if (returnValues.attributes[key].length &gt; 0) {
                  var value = returnValues.attributes[key];
                  linkElement.data('cke-saved-' + key, value);
                  linkElement.setAttribute(key, value);
                }
                // Delete the property if set to an empty string.
                else {
                  linkElement.removeAttribute(key);
                }
              }
            }
          }

          // Save snapshot for undo support.
          editor.fire('saveSnapshot');
        };
        // Drupal.t() will not work inside CKEditor plugins because CKEditor
        // loads the JavaScript file instead of Drupal. Pull translated strings
        // from the plugin settings that are translated server-side.
        var dialogSettings = {
          title: linkElement ? editor.config.drupalLink_dialogTitleEdit : editor.config.drupalLink_dialogTitleAdd,
          dialogClass: 'editor-link-dialog'
        };

        // Open the dialog for the edit form.
        Drupal.ckeditor.openDialog(editor, Drupal.url('editor/dialog/link/' + editor.config.drupal.format), existingValues, saveCallback, dialogSettings);
      }
    });
    editor.addCommand('drupalunlink', {
      contextSensitive: 1,
      startDisabled: 1,
      allowedContent: 'a[!href]',
      requiredContent: 'a[href]',
      exec: function (editor) {
        var style = new CKEDITOR.style({ element:'a', type: CKEDITOR.STYLE_INLINE, alwaysRemoveElement: 1 });
        editor.removeStyle(style);
      },
      refresh: function ( editor, path ) {
        var element = path.lastElement &amp;&amp; path.lastElement.getAscendant('a', true);
        if (element &amp;&amp; element.getName() === 'a' &amp;&amp; element.getAttribute('href') &amp;&amp; element.getChildCount()) {
          this.setState(CKEDITOR.TRISTATE_OFF);
        }
        else {
          this.setState(CKEDITOR.TRISTATE_DISABLED);
        }
      }
    });

    editor.setKeystroke(CKEDITOR.CTRL + 75 /*K*/, 'drupallink');

    // Add buttons for link and unlink.
    if (editor.ui.addButton) {
      editor.ui.addButton('DrupalLink', {
        label: Drupal.t('Link'),
        command: 'drupallink',
        icon: this.path.replace(/plugin\.js.*/, 'link.png')
      });
      editor.ui.addButton('DrupalUnlink', {
        label: Drupal.t('Unlink'),
        command: 'drupalunlink',
        icon: this.path.replace(/plugin\.js.*/, 'unlink.png')
      });
    }

    editor.on('doubleclick', function (evt) {
      var element = getSelectedLink(editor) || evt.data.element;

      if (!element.isReadOnly()) {
        if (element.is('a')) {
          editor.getSelection().selectElement(element);
          editor.getCommand('drupallink').exec();
        }
      }
    });

    // If the "menu" plugin is loaded, register the menu items.
    if (editor.addMenuItems) {
      editor.addMenuItems({
        link: {
          label: Drupal.t('Edit Link'),
          command: 'drupallink',
          group: 'link',
          order: 1
        },

        unlink: {
          label: Drupal.t('Unlink'),
          command: 'drupalunlink',
          group: 'link',
          order: 5
        }
      });
    }

    // If the "contextmenu" plugin is loaded, register the listeners.
    if (editor.contextMenu) {
      editor.contextMenu.addListener(function (element, selection) {
        if (!element || element.isReadOnly()) {
          return null;
        }
        var anchor = getSelectedLink(editor);
        if (!anchor) {
          return null;
        }

        var menu = {};
        if (anchor.getAttribute('href') &amp;&amp; anchor.getChildCount()) {
          menu = { link: CKEDITOR.TRISTATE_OFF, unlink: CKEDITOR.TRISTATE_OFF };
        }
        return menu;
      });
    }
  }
});


/**
 * Get the surrounding link element of current selection.
 *
 * The following selection will all return the link element.
 *
 *  &lt;a href="#"&gt;li^nk&lt;/a&gt;
 *  &lt;a href="#"&gt;[link]&lt;/a&gt;
 *  text[&lt;a href="#"&gt;link]&lt;/a&gt;
 *  &lt;a href="#"&gt;li[nk&lt;/a&gt;]
 *  [&lt;b&gt;&lt;a href="#"&gt;li]nk&lt;/a&gt;&lt;/b&gt;]
 *  [&lt;a href="#"&gt;&lt;b&gt;li]nk&lt;/b&gt;&lt;/a&gt;
 *
 * @param {CKEDITOR.editor} editor
 */
function getSelectedLink(editor) {
  var selection = editor.getSelection();
  var selectedElement = selection.getSelectedElement();
  if (selectedElement &amp;&amp; selectedElement.is('a')) {
    return selectedElement;
  }

  var range = selection.getRanges(true)[0];

  if (range) {
    range.shrink(CKEDITOR.SHRINK_TEXT);
    return editor.elementPath(range.getCommonAncestor()).contains('a', 1);
  }
  return null;
}

})(jQuery, Drupal, drupalSettings, CKEDITOR);
</code>
</pre>
              </article>
            </section>
          </div>
        </div>
        <nav class="pure-u-1-5">
          <div class="box">
            <h2>
              <a href="index.html">Index</a>
            </h2>
            <h3>
              Classes
            </h3>
            <ul>
              <li>
                <a href="Drupal.ajax.html">Drupal.ajax</a>
              </li>
              <li>
                <a href="Drupal.AjaxCommands.html">Drupal.AjaxCommands</a>
              </li>
              <li>
                <a href="Drupal.AjaxError.html">Drupal.AjaxError</a>
              </li>
              <li>
                <a href="Drupal.CollapsibleDetails.html">Drupal.CollapsibleDetails</a>
              </li>
              <li>
                <a href="Drupal.contextual.AuralView.html">Drupal.contextual.AuralView</a>
              </li>
              <li>
                <a href="Drupal.contextual.KeyboardView.html">Drupal.contextual.KeyboardView</a>
              </li>
              <li>
                <a href="Drupal.contextual.RegionView.html">Drupal.contextual.RegionView</a>
              </li>
              <li>
                <a href="Drupal.contextual.StateModel.html">Drupal.contextual.StateModel</a>
              </li>
              <li>
                <a href="Drupal.contextual.VisualView.html">Drupal.contextual.VisualView</a>
              </li>
              <li>
                <a href="Drupal.contextualToolbar.Model.html">Drupal.contextualToolbar.Model</a>
              </li>
              <li>
                <a href="Drupal.contextualToolbar.VisualView.html">Drupal.contextualToolbar.VisualView</a>
              </li>
              <li>
                <a href="Drupal.DropButton.html">Drupal.DropButton</a>
              </li>
              <li>
                <a href="Drupal.edit.AppModel.html">Drupal.edit.AppModel</a>
              </li>
              <li>
                <a href="Drupal.edit.AppView.html">Drupal.edit.AppView</a>
              </li>
              <li>
                <a href="Drupal.edit.BaseModel.html">Drupal.edit.BaseModel</a>
              </li>
              <li>
                <a href="Drupal.edit.ContextualLinkView.html">Drupal.edit.ContextualLinkView</a>
              </li>
              <li>
                <a href="Drupal.edit.EditorModel.html">Drupal.edit.EditorModel</a>
              </li>
              <li>
                <a href="Drupal.edit.editors.editor.html">Drupal.edit.editors.editor</a>
              </li>
              <li>
                <a href="Drupal.edit.editors.form.html">Drupal.edit.editors.form</a>
              </li>
              <li>
                <a href="Drupal.edit.editors.plain_text.html">Drupal.edit.editors.plain_text</a>
              </li>
              <li>
                <a href="Drupal.edit.EditorView.html">Drupal.edit.EditorView</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityCollection.html">Drupal.edit.EntityCollection</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityDecorationView.html">Drupal.edit.EntityDecorationView</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityModel.html">Drupal.edit.EntityModel</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityToolbarView.html">Drupal.edit.EntityToolbarView</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldCollection.html">Drupal.edit.FieldCollection</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldDecorationView.html">Drupal.edit.FieldDecorationView</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldModel.html">Drupal.edit.FieldModel</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldToolbarView.html">Drupal.edit.FieldToolbarView</a>
              </li>
              <li>
                <a href="Drupal.EditorFeature.html">Drupal.EditorFeature</a>
              </li>
              <li>
                <a href="Drupal.EditorFeatureHTMLRule.html">Drupal.EditorFeatureHTMLRule</a>
              </li>
              <li>
                <a href="Drupal.fieldUIDisplayOverview.field.html">Drupal.fieldUIDisplayOverview.field</a>
              </li>
              <li>
                <a href="Drupal.FilterHTMLRule.html">Drupal.FilterHTMLRule</a>
              </li>
              <li>
                <a href="Drupal.FilterStatus.html">Drupal.FilterStatus</a>
              </li>
              <li>
                <a href="Drupal.ProgressBar.html">Drupal.ProgressBar</a>
              </li>
              <li>
                <a href="Drupal.states.Dependent.html">Drupal.states.Dependent</a>
              </li>
              <li>
                <a href="Drupal.states.State.html">Drupal.states.State</a>
              </li>
              <li>
                <a href="Drupal.states.Trigger.html">Drupal.states.Trigger</a>
              </li>
              <li>
                <a href="Drupal.tableDrag.html">Drupal.tableDrag</a>
              </li>
              <li>
                <a href="Drupal.TableHeader.html">Drupal.TableHeader</a>
              </li>
              <li>
                <a href="Drupal.TableResponsive.html">Drupal.TableResponsive</a>
              </li>
              <li>
                <a href="Drupal.toolbar.BodyVisualView.html">Drupal.toolbar.BodyVisualView</a>
              </li>
              <li>
                <a href="Drupal.toolbar.MenuModel.html">Drupal.toolbar.MenuModel</a>
              </li>
              <li>
                <a href="Drupal.toolbar.MenuVisualView.html">Drupal.toolbar.MenuVisualView</a>
              </li>
              <li>
                <a href="Drupal.toolbar.ToolbarAuralView.html">Drupal.toolbar.ToolbarAuralView</a>
              </li>
              <li>
                <a href="Drupal.toolbar.ToolbarModel.html">Drupal.toolbar.ToolbarModel</a>
              </li>
              <li>
                <a href="Drupal.toolbar.ToolbarVisualView.html">Drupal.toolbar.ToolbarVisualView</a>
              </li>
              <li>
                <a href="Drupal.tour.models.StateModel.html">Drupal.tour.models.StateModel</a>
              </li>
              <li>
                <a href="Drupal.tour.views.ToggleTourView.html">Drupal.tour.views.ToggleTourView</a>
              </li>
              <li>
                <a href="Drupal.verticalTab.html">Drupal.verticalTab</a>
              </li>
              <li>
                <a href="Drupal.views.ajaxView.html">Drupal.views.ajaxView</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.AddItemForm.html">Drupal.viewsUi.AddItemForm</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.Checkboxifier.html">Drupal.viewsUi.Checkboxifier</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.FormFieldFiller.html">Drupal.viewsUi.FormFieldFiller</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.OptionsSearch.html">Drupal.viewsUi.OptionsSearch</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.RearrangeFilterHandler.html">Drupal.viewsUi.RearrangeFilterHandler</a>
              </li>
            </ul>
            <h3>
              Events
            </h3>
            <ul>
              <li>
                <a href="global.html#event:drupalViewportOffsetChange">event:drupalViewportOffsetChange</a>
              </li>
              <li>
                <a href="global.html#event:formUpdated">event:formUpdated</a>
              </li>
              <li>
                <a href="global.html#event:summaryUpdated">event:summaryUpdated</a>
              </li>
            </ul>
            <h3>
              Namespaces
            </h3>
            <ul>
              <li>
                <a href="Drupal.html" class="root">Drupal</a>
              </li>
              <li>
                <a href="Drupal.behaviors.html">Drupal.behaviors</a>
              </li>
              <li>
                <a href="Drupal.ckeditor.html">Drupal.ckeditor</a>
              </li>
              <li>
                <a href="Drupal.color.html">Drupal.color</a>
              </li>
              <li>
                <a href="Drupal.contextual.html">Drupal.contextual</a>
              </li>
              <li>
                <a href="Drupal.contextualToolbar.html">Drupal.contextualToolbar</a>
              </li>
              <li>
                <a href="Drupal.edit.html">Drupal.edit</a>
              </li>
              <li>
                <a href="Drupal.edit.metadata.html">Drupal.edit.metadata</a>
              </li>
              <li>
                <a href="Drupal.edit.util.html">Drupal.edit.util</a>
              </li>
              <li>
                <a href="Drupal.edit.util.constants.html">Drupal.edit.util.constants</a>
              </li>
              <li>
                <a href="Drupal.edit.util.form.html">Drupal.edit.util.form</a>
              </li>
              <li>
                <a href="Drupal.editorConfiguration.html">Drupal.editorConfiguration</a>
              </li>
              <li>
                <a href="Drupal.editors.html">Drupal.editors</a>
              </li>
              <li>
                <a href="Drupal.fieldUIDisplayOverview.html">Drupal.fieldUIDisplayOverview</a>
              </li>
              <li>
                <a href="Drupal.fieldUIOverview.html">Drupal.fieldUIOverview</a>
              </li>
              <li>
                <a href="Drupal.file.html">Drupal.file</a>
              </li>
              <li>
                <a href="Drupal.filterConfiguration.html">Drupal.filterConfiguration</a>
              </li>
              <li>
                <a href="Drupal.filterConfiguration.liveSettingParsers.html">Drupal.filterConfiguration.liveSettingParsers</a>
              </li>
              <li>
                <a href="Drupal.history.html">Drupal.history</a>
              </li>
              <li>
                <a href="Drupal.states.html">Drupal.states</a>
              </li>
              <li>
                <a href="Drupal.states.Trigger.states.html">Drupal.states.Trigger.states</a>
              </li>
              <li>
                <a href="Drupal.theme.html">Drupal.theme</a>
              </li>
              <li>
                <a href="Drupal.toolbar.html">Drupal.toolbar</a>
              </li>
              <li>
                <a href="Drupal.tour.html">Drupal.tour</a>
              </li>
              <li>
                <a href="Drupal.tour.models.html">Drupal.tour.models</a>
              </li>
              <li>
                <a href="Drupal.tour.views.html">Drupal.tour.views</a>
              </li>
              <li>
                <a href="Drupal.views.html">Drupal.views</a>
              </li>
              <li>
                <a href="Drupal.Views_.html">Drupal.Views</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.html">Drupal.viewsUi</a>
              </li>
            </ul>
            <h3>
              Global
            </h3>
            <ul>
              <li>
                <a href="global.html#drupalSettings" class="root">drupalSettings</a>
              </li>
              <li>
                <a href="global.html#matchMedia" class="root">matchMedia</a>
              </li>
            </ul>
            <p>
              <strong>For more information about this documentation please see <a href="https://drupal.org/node/2182153">Issue #2182153: Use JSDoc</a>.</strong>
            </p>
          </div>
        </nav>
      </div>
    </div><script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47079344-1', 'theodoreb.net');
    ga('send', 'pageview');
    </script><script type="text/javascript">
prettyPrint();
    </script><script src="scripts/linenumber.js" type="text/javascript">
</script>
  </body>
</html>
