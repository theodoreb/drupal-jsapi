<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="generator" content="HTML Tidy for Linux (vers 25 March 2009), see www.w3.org">
    <meta charset="utf-8">
    <title>
      Source: modules/ckeditor/js/plugins/drupalimagecaption/theme.js — Drupal JS API
    </title>
    <script src="scripts/prettify/prettify.js" type="text/javascript">
</script>
    <script src="scripts/prettify/lang-css.js" type="text/javascript">
</script>
    <link type="text/css" rel="stylesheet" href="pure/pure.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/drupal.css">
  </head>
  <body>
    <div id="main" class="pure">
      <div class="pure-g">
        <div class="pure-u-4-5">
          <div class="box">
            <h1 class="page-title">
              Source: modules/ckeditor/js/plugins/drupalimagecaption/theme.js
            </h1>
            <section>
              <article>
                <pre class="prettyprint source">
<code>/**
 * @file
 * Drupal Image Caption plugin theme override.
 */

(function (CKEDITOR) {

"use strict";

CKEDITOR.on('instanceCreated', function (event) {
  var editor = event.editor;

  // Listen to widget definitions and customize them as needed. It's
  // basically rewriting parts of the definition.
  editor.on('widgetDefinition', function (event) {
    var widgetDefinition = event.data;

    // Customize the "drupalimagecaption" widget definition.
    if (widgetDefinition.name === 'drupalimagecaption') {

      widgetDefinition.template =
        '&lt;figure class="caption caption-img"&gt;' +
          '&lt;img src="" data-caption="" data-align="center" /&gt;' +
          '&lt;figcaption&gt;&lt;/figcaption&gt;' +
        '&lt;/figure&gt;';

      // Define the editables created by the overridden upcasting.
      widgetDefinition.editables = {
        caption: 'figcaption'
      };

      // Define the additional parts created by the overridden upcasting.
      widgetDefinition.parts.caption = 'figcaption';

      // Override "data" so we can make the new widget structure
      // behave according to changes on data.
      widgetDefinition.data = CKEDITOR.tools.override(widgetDefinition.data, function (originalDataFn) {
        return function () {
          // Call the original "data" implementation.
          originalDataFn.apply(this, arguments);

          // The image is wrapped in &lt;figure&gt;.
          if (this.element.is('figure')) {
            // The image is wrapped in &lt;figure&gt;, but it should no longer be.
            if (!this.data.hasCaption &amp;&amp; this.data.data_align === null) {
              // Destroy this widget, so we can unwrap the &lt;img&gt;.
              editor.widgets.destroy(this);
              // Unwrap &lt;img&gt; from &lt;figure&gt;.
              this.parts.image.replace(this.element);
              // Reinitialize this widget with the current data.
              editor.widgets.initOn(this.parts.image, 'drupalimagecaption', this.data);
            }
            // The image is wrapped in &lt;figure&gt;, as it should be; update it.
            else {
              // Set the caption visibility.
              this.parts.caption.setStyle('display', this.data.hasCaption ? '' : 'none');

              // Set the alignment, if any.
              this.element.removeClass('caption-left');
              this.element.removeClass('caption-center');
              this.element.removeClass('caption-right');
              if (this.data.data_align) {
                this.element.addClass('caption-' + this.data.data_align);
              }
            }
          }
          // The image is not wrapped in &lt;figure&gt;.
          else if (this.element.is('img')) {
            // The image is not wrapped in &lt;figure&gt;, but it should be.
            if (this.data.hasCaption) {
              // Destroy this widget, so we can wrap the &lt;img&gt;.
              editor.widgets.destroy(this);
              // Replace the widget's element (the &lt;img&gt;) with the template (a
              // &lt;figure&gt; wrapping an &lt;img&gt;) and then replace the the template's
              // default &lt;img&gt; by our &lt;img&gt; so we won't lose attributes. We must
              // do this manually because upcast() won't run.
              var figure = CKEDITOR.dom.element.createFromHtml(this.template.output(), editor.document);
              figure.replace(this.element);
              this.element.replace(figure.findOne('img'));
              // Reinitialize this widget with the current data.
              editor.widgets.initOn(figure, 'drupalimagecaption', this.data);
            }
            else if (this.data.data_align !== null) {
              this.element.addClass('align-' + this.data.data_align);
            }
          }
        };
      });

      // Upcast to &lt;figure&gt; if data-caption or data-align is set.
      widgetDefinition.upcast = CKEDITOR.tools.override(widgetDefinition.upcast, function (originalUpcastFn) {
        return function (el) {
          // Execute the original upcast first. If "true", this is an
          // element to be upcasted.
          if (originalUpcastFn.apply(this, arguments)) {
            var figure;
            var captionValue = el.attributes['data-caption'];
            var alignValue = el.attributes['data-align'];

            // Wrap image in &lt;figure&gt; only if data-caption is set.
            if (captionValue !== undefined) {
              var classes = 'caption caption-img';
              if (alignValue !== null) {
                classes += ' caption-' + alignValue;
              }
              figure = el.wrapWith(new CKEDITOR.htmlParser.element('figure', { 'class' : classes }));
              var caption = CKEDITOR.htmlParser.fragment.fromHtml(captionValue || '', 'figcaption');
              figure.add(caption);
            }
            else if (alignValue !== undefined) {
              if (el.attributes['class'] === undefined) {
                el.attributes['class'] = '';
              }
              el.attributes['class'] += 'align-' + alignValue;
            }

            return figure || el;
          }
        };
      });

      // Downcast to &lt;img&gt;.
      widgetDefinition.downcast = CKEDITOR.tools.override(widgetDefinition.downcast, function (originalDowncastFn) {
        return function (el) {
          if (el.name === 'figure') {
            // Update data with the current caption.
            var caption = el.getFirst('figcaption');
            caption = caption ? caption.getHtml() : '';
            this.setData({
              data_caption: caption
            });

            // We downcast to just the &lt;img&gt; element.
            el = el.getFirst('img');
          }

          // Call the original downcast to setup the &lt;img&gt;
          // meta data accordingly.
          return originalDowncastFn.call(this, el) || el;
        };
      });

      // Generate a &lt;figure&gt;-wrapped &lt;img&gt; if either data-caption or data-align
      // are set for a newly created image.
      widgetDefinition.insert = CKEDITOR.tools.override(widgetDefinition.downcast, function (originalInsertFn) {
        return function () {
          var saveCallback = function (returnValues) {
            // We can't create an image with an empty "src" attribute.
            if (returnValues.attributes.src.length === 0) {
              return;
            }
            // Normalize the "data_align" attribute and the "hasCaption" value.
            if (returnValues.attributes.data_align === '' || returnValues.attributes.data_align === 'none') {
              returnValues.attributes.data_align = null;
            }
            if (typeof returnValues.hasCaption === 'number') {
              returnValues.hasCaption = !!returnValues.hasCaption;
            }
            // Use the original save callback if the image has no caption.
            if (returnValues.hasCaption === false) {
              widgetDefinition._insertSaveCallback.apply(this, arguments);
              return;
            }

            editor.fire('saveSnapshot');

            // Build the HTML for the widget.
            var html = '&lt;figure class="caption caption-img';
            if (returnValues.attributes.data_align &amp;&amp; returnValues.attributes.data_align !== 'none') {
              html += ' caption-' + returnValues.attributes.data_align;
            }
            html += '"&gt;&lt;img ';
            for (var attr in returnValues.attributes) {
              if (returnValues.attributes.hasOwnProperty(attr) &amp;&amp; !attr.match(/^data_/)) {
                html += attr + '="' + returnValues.attributes[attr] + '" ';
                html += 'data-cke-saved-' + attr + '="' + returnValues.attributes[attr] + '" ';
              }
            }
            // The init() method will run on this and if it does not find
            // data-caption or data-align attributes, the subsequent call to the
            // data() method will cause the &lt;figure&gt; to be transformed back to
            // an &lt;img&gt;. Hence, set the data-caption and data-align attributes
            // on the newly inserted &lt;img&gt;.
            if (returnValues.hasCaption) {
              html += ' data-caption=""';
              html += ' data-cke-saved-data-caption=""';
            }
            if (returnValues.attributes.data_align &amp;&amp; returnValues.attributes.data_align !== 'none') {
              html += ' data-align="' + returnValues.attributes.data_align + '"';
              html += ' data-cke-saved-data-align="' + returnValues.attributes.data_align + '"';
            }
            html += '/&gt;';
            html += '&lt;figcaption data-placeholder="' + Drupal.t('Enter caption here') + '"&gt;&lt;/figcaption&gt;';
            html += '&lt;/figure&gt;';
            var el = new CKEDITOR.dom.element.createFromHtml(html, editor.document);
            editor.insertElement(editor.widgets.wrapElement(el, 'drupalimagecaption'));

            // Save snapshot for undo support.
            editor.fire('saveSnapshot');

            // Initialize and focus the widget.
            var widget = editor.widgets.initOn(el, 'drupalimagecaption');
            widget.focus();
          };
          var override = {
            imageDOMElement: null,
            existingValues: { hasCaption: false, data_align: '' },
            saveCallback: saveCallback,
            dialogTitle: editor.config.drupalImage_dialogTitleAdd
          };
          if (this._selectionWillCreateInlineImage()) {
            override.existingValues.isInline = this._selectionWillCreateInlineImage();
            delete override.saveCallback;
          }
          editor.execCommand('drupalimage', override);
        };
      });
    }
  });
});

})(CKEDITOR);
</code>
</pre>
              </article>
            </section>
          </div>
        </div>
        <nav class="pure-u-1-5">
          <div class="box">
            <h2>
              <a href="index.html">Index</a>
            </h2>
            <h3>
              Classes
            </h3>
            <ul>
              <li>
                <a href="Drupal.ajax.html">Drupal.ajax</a>
              </li>
              <li>
                <a href="Drupal.AjaxCommands.html">Drupal.AjaxCommands</a>
              </li>
              <li>
                <a href="Drupal.AjaxError.html">Drupal.AjaxError</a>
              </li>
              <li>
                <a href="Drupal.CollapsibleDetails.html">Drupal.CollapsibleDetails</a>
              </li>
              <li>
                <a href="Drupal.contextual.AuralView.html">Drupal.contextual.AuralView</a>
              </li>
              <li>
                <a href="Drupal.contextual.KeyboardView.html">Drupal.contextual.KeyboardView</a>
              </li>
              <li>
                <a href="Drupal.contextual.RegionView.html">Drupal.contextual.RegionView</a>
              </li>
              <li>
                <a href="Drupal.contextual.StateModel.html">Drupal.contextual.StateModel</a>
              </li>
              <li>
                <a href="Drupal.contextual.VisualView.html">Drupal.contextual.VisualView</a>
              </li>
              <li>
                <a href="Drupal.contextualToolbar.Model.html">Drupal.contextualToolbar.Model</a>
              </li>
              <li>
                <a href="Drupal.contextualToolbar.VisualView.html">Drupal.contextualToolbar.VisualView</a>
              </li>
              <li>
                <a href="Drupal.DropButton.html">Drupal.DropButton</a>
              </li>
              <li>
                <a href="Drupal.edit.AppModel.html">Drupal.edit.AppModel</a>
              </li>
              <li>
                <a href="Drupal.edit.AppView.html">Drupal.edit.AppView</a>
              </li>
              <li>
                <a href="Drupal.edit.BaseModel.html">Drupal.edit.BaseModel</a>
              </li>
              <li>
                <a href="Drupal.edit.ContextualLinkView.html">Drupal.edit.ContextualLinkView</a>
              </li>
              <li>
                <a href="Drupal.edit.EditorModel.html">Drupal.edit.EditorModel</a>
              </li>
              <li>
                <a href="Drupal.edit.editors.editor.html">Drupal.edit.editors.editor</a>
              </li>
              <li>
                <a href="Drupal.edit.editors.form.html">Drupal.edit.editors.form</a>
              </li>
              <li>
                <a href="Drupal.edit.editors.plain_text.html">Drupal.edit.editors.plain_text</a>
              </li>
              <li>
                <a href="Drupal.edit.EditorView.html">Drupal.edit.EditorView</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityCollection.html">Drupal.edit.EntityCollection</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityDecorationView.html">Drupal.edit.EntityDecorationView</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityModel.html">Drupal.edit.EntityModel</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityToolbarView.html">Drupal.edit.EntityToolbarView</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldCollection.html">Drupal.edit.FieldCollection</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldDecorationView.html">Drupal.edit.FieldDecorationView</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldModel.html">Drupal.edit.FieldModel</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldToolbarView.html">Drupal.edit.FieldToolbarView</a>
              </li>
              <li>
                <a href="Drupal.EditorFeature.html">Drupal.EditorFeature</a>
              </li>
              <li>
                <a href="Drupal.EditorFeatureHTMLRule.html">Drupal.EditorFeatureHTMLRule</a>
              </li>
              <li>
                <a href="Drupal.fieldUIDisplayOverview.field.html">Drupal.fieldUIDisplayOverview.field</a>
              </li>
              <li>
                <a href="Drupal.FilterHTMLRule.html">Drupal.FilterHTMLRule</a>
              </li>
              <li>
                <a href="Drupal.FilterStatus.html">Drupal.FilterStatus</a>
              </li>
              <li>
                <a href="Drupal.ProgressBar.html">Drupal.ProgressBar</a>
              </li>
              <li>
                <a href="Drupal.states.Dependent.html">Drupal.states.Dependent</a>
              </li>
              <li>
                <a href="Drupal.states.State.html">Drupal.states.State</a>
              </li>
              <li>
                <a href="Drupal.states.Trigger.html">Drupal.states.Trigger</a>
              </li>
              <li>
                <a href="Drupal.tableDrag.html">Drupal.tableDrag</a>
              </li>
              <li>
                <a href="Drupal.TableHeader.html">Drupal.TableHeader</a>
              </li>
              <li>
                <a href="Drupal.TableResponsive.html">Drupal.TableResponsive</a>
              </li>
              <li>
                <a href="Drupal.toolbar.BodyVisualView.html">Drupal.toolbar.BodyVisualView</a>
              </li>
              <li>
                <a href="Drupal.toolbar.MenuModel.html">Drupal.toolbar.MenuModel</a>
              </li>
              <li>
                <a href="Drupal.toolbar.MenuVisualView.html">Drupal.toolbar.MenuVisualView</a>
              </li>
              <li>
                <a href="Drupal.toolbar.ToolbarAuralView.html">Drupal.toolbar.ToolbarAuralView</a>
              </li>
              <li>
                <a href="Drupal.toolbar.ToolbarModel.html">Drupal.toolbar.ToolbarModel</a>
              </li>
              <li>
                <a href="Drupal.toolbar.ToolbarVisualView.html">Drupal.toolbar.ToolbarVisualView</a>
              </li>
              <li>
                <a href="Drupal.tour.models.StateModel.html">Drupal.tour.models.StateModel</a>
              </li>
              <li>
                <a href="Drupal.tour.views.ToggleTourView.html">Drupal.tour.views.ToggleTourView</a>
              </li>
              <li>
                <a href="Drupal.verticalTab.html">Drupal.verticalTab</a>
              </li>
              <li>
                <a href="Drupal.views.ajaxView.html">Drupal.views.ajaxView</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.AddItemForm.html">Drupal.viewsUi.AddItemForm</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.Checkboxifier.html">Drupal.viewsUi.Checkboxifier</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.FormFieldFiller.html">Drupal.viewsUi.FormFieldFiller</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.OptionsSearch.html">Drupal.viewsUi.OptionsSearch</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.RearrangeFilterHandler.html">Drupal.viewsUi.RearrangeFilterHandler</a>
              </li>
            </ul>
            <h3>
              Events
            </h3>
            <ul>
              <li>
                <a href="global.html#event:drupalViewportOffsetChange">event:drupalViewportOffsetChange</a>
              </li>
              <li>
                <a href="global.html#event:formUpdated">event:formUpdated</a>
              </li>
              <li>
                <a href="global.html#event:summaryUpdated">event:summaryUpdated</a>
              </li>
            </ul>
            <h3>
              Namespaces
            </h3>
            <ul>
              <li>
                <a href="Drupal.html" class="root">Drupal</a>
              </li>
              <li>
                <a href="Drupal.behaviors.html">Drupal.behaviors</a>
              </li>
              <li>
                <a href="Drupal.color.html">Drupal.color</a>
              </li>
              <li>
                <a href="Drupal.contextual.html">Drupal.contextual</a>
              </li>
              <li>
                <a href="Drupal.contextualToolbar.html">Drupal.contextualToolbar</a>
              </li>
              <li>
                <a href="Drupal.edit.html">Drupal.edit</a>
              </li>
              <li>
                <a href="Drupal.edit.metadata.html">Drupal.edit.metadata</a>
              </li>
              <li>
                <a href="Drupal.edit.util.html">Drupal.edit.util</a>
              </li>
              <li>
                <a href="Drupal.edit.util.constants.html">Drupal.edit.util.constants</a>
              </li>
              <li>
                <a href="Drupal.edit.util.form.html">Drupal.edit.util.form</a>
              </li>
              <li>
                <a href="Drupal.editorConfiguration.html">Drupal.editorConfiguration</a>
              </li>
              <li>
                <a href="Drupal.editors.html">Drupal.editors</a>
              </li>
              <li>
                <a href="Drupal.fieldUIDisplayOverview.html">Drupal.fieldUIDisplayOverview</a>
              </li>
              <li>
                <a href="Drupal.fieldUIOverview.html">Drupal.fieldUIOverview</a>
              </li>
              <li>
                <a href="Drupal.file.html">Drupal.file</a>
              </li>
              <li>
                <a href="Drupal.filterConfiguration.html">Drupal.filterConfiguration</a>
              </li>
              <li>
                <a href="Drupal.filterConfiguration.liveSettingParsers.html">Drupal.filterConfiguration.liveSettingParsers</a>
              </li>
              <li>
                <a href="Drupal.history.html">Drupal.history</a>
              </li>
              <li>
                <a href="Drupal.states.html">Drupal.states</a>
              </li>
              <li>
                <a href="Drupal.states.Trigger.states.html">Drupal.states.Trigger.states</a>
              </li>
              <li>
                <a href="Drupal.theme.html">Drupal.theme</a>
              </li>
              <li>
                <a href="Drupal.toolbar.html">Drupal.toolbar</a>
              </li>
              <li>
                <a href="Drupal.tour.html">Drupal.tour</a>
              </li>
              <li>
                <a href="Drupal.tour.models.html">Drupal.tour.models</a>
              </li>
              <li>
                <a href="Drupal.tour.views.html">Drupal.tour.views</a>
              </li>
              <li>
                <a href="Drupal.Views.html">Drupal.Views</a>
              </li>
              <li>
                <a href="Drupal.views_.html">Drupal.views</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.html">Drupal.viewsUi</a>
              </li>
            </ul>
            <h3>
              Global
            </h3>
            <ul>
              <li>
                <a href="global.html#drupalSettings" class="root">drupalSettings</a>
              </li>
              <li>
                <a href="global.html#matchMedia" class="root">matchMedia</a>
              </li>
            </ul>
            <p>
              <strong>For more information about this documentation please see <a href="#todo">Issue #XXX</a>.</strong>
            </p>
          </div>
        </nav>
      </div>
    </div><script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47079344-1', 'theodoreb.net');
    ga('send', 'pageview');
    </script><script type="text/javascript">
prettyPrint();
    </script><script src="scripts/linenumber.js" type="text/javascript">
</script>
  </body>
</html>
