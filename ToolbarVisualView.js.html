<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="generator" content="HTML Tidy for Linux (vers 25 March 2009), see www.w3.org">
    <meta charset="utf-8">
    <title>
      Source: modules/toolbar/js/views/ToolbarVisualView.js — Drupal JS API
    </title>
    <script src="scripts/prettify/prettify.js" type="text/javascript">
</script>
    <script src="scripts/prettify/lang-css.js" type="text/javascript">
</script>
    <link type="text/css" rel="stylesheet" href="pure/pure.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/drupal.css">
  </head>
  <body>
    <div id="main" class="pure">
      <div class="pure-g">
        <div class="pure-u-4-5">
          <div class="box">
            <h1 class="page-title">
              Source: modules/toolbar/js/views/ToolbarVisualView.js
            </h1>
            <section>
              <article>
                <pre class="prettyprint source">
<code>/**
 * @file
 * A Backbone view for the toolbar element.
 */
(function ($, Drupal, drupalSettings, Backbone) {

"use strict";

Drupal.toolbar.ToolbarVisualView = Backbone.View.extend(/** @lends Drupal.toolbar.ToolbarVisualView# */ {

  /**
   * @type {Object}
   */
  events: {
    'click .toolbar-bar .toolbar-tab': 'onTabClick',
    'click .toolbar-toggle-orientation button': 'onOrientationToggleClick'
  },

  /**
   * Backbone view for the toolbar element.
   *
   * @constructs Drupal.toolbar.ToolbarVisualView
   * @augments Backbone.View
   * @param {Object} options
   * @param {Object} options.strings
   * @param {String} options.strings.vertical
   * @param {String} options.strings.horizontal
   */
  initialize: function (options) {
    this.strings = options.strings;

    this.listenTo(this.model, 'change:activeTab change:orientation change:isOriented change:isTrayToggleVisible', this.render);
    this.listenTo(this.model, 'change:mqMatches', this.onMediaQueryChange);
    this.listenTo(this.model, 'change:offsets', this.adjustPlacement);

    /**
     * Add the tray orientation toggles.
     * @type {jQueryObject}
     */
    this.$el
      .find('.toolbar-tray .toolbar-lining')
      .append(Drupal.theme('toolbarOrientationToggle'));

    // Trigger an activeTab change so that listening scripts can respond on
    // page load. This will call render.
    this.model.trigger('change:activeTab');
  },

  /**
   * @method
   */
  render: function () {
    this.updateTabs();
    this.updateTrayOrientation();
    this.updateBarAttributes();
    // Load the subtrees if the orientation of the toolbar is changed to
    // vertical. This condition responds to the case that the toolbar switches
    // from horizontal to vertical orientation. The toolbar starts in a
    // vertical orientation by default and then switches to horizontal during
    // initialization if the media query conditions are met. Simply checking
    // that the orientation is vertical here would result in the subtrees
    // always being loaded, even when the toolbar initialization ultimately
    // results in a horizontal orientation.
    //
    // @see Drupal.behaviors.toolbar.attach() where admin menu subtrees
    // loading is invoked during initialization after media query conditions
    // have been processed.
    if (this.model.changed.orientation === 'vertical' || this.model.changed.activeTab) {
      this.loadSubtrees();
    }
    // Trigger a recalculation of viewport displacing elements. Use setTimeout
    // to ensure this recalculation happens after changes to visual elements
    // have processed.
    window.setTimeout(function () {
      Drupal.displace(true);
    }, 0);
    return this;
  },

  /**
   * Responds to a toolbar tab click.
   *
   * @param {Event} event
   */
  onTabClick: function (event) {
    // If this tab has a tray associated with it, it is considered an
    // activatable tab.
    if (event.target.hasAttribute('data-toolbar-tray')) {
      var tab = this.model.get('activeTab');
      var id = '#' + event.target.id;
      // Set the event target as the active item if it is not already.
      this.model.set('activeTab', (!tab || id !== tab) ? id : null);

      event.preventDefault();
      event.stopPropagation();
    }
  },

  /**
   * Toggles the orientation of a toolbar tray.
   *
   * @param {Event} event
   */
  onOrientationToggleClick: function (event) {
    var orientation = this.model.get('orientation');
    // Determine the toggle-to orientation.
    var antiOrientation = (orientation === 'vertical') ? 'horizontal' : 'vertical';
    var locked = (antiOrientation === 'vertical') ? true : false;
    // Remember the locked state.
    if (locked) {
      localStorage.setItem('Drupal.toolbar.trayVerticalLocked', 'true');
    }
    else {
      localStorage.removeItem('Drupal.toolbar.trayVerticalLocked');
    }
    // Update the model.
    this.model.set({
      locked: locked,
      orientation: antiOrientation
    }, {
      validate: true,
      override: true
    });

    event.preventDefault();
    event.stopPropagation();
  },

  /**
   * Updates the display of the tabs: toggles a tab and the associated tray.
   */
  updateTabs: function () {
    var $tab = $(this.model.get('activeTab'));
    // Deactivate the previous tab.
    $(this.model.previous('activeTab'))
      .removeClass('active')
      .prop('aria-pressed', false);
    // Deactivate the previous tray.
    $(this.model.previous('activeTray'))
      .removeClass('active');

    // Activate the selected tab.
    if ($tab.length &gt; 0) {
      $tab
        .addClass('active')
        // Mark the tab as pressed.
        .prop('aria-pressed', true);
      var name = $tab.attr('data-toolbar-tray');
      // Store the active tab name or remove the setting.
      var id = $tab.get(0).id;
      if (id) {
        localStorage.setItem('Drupal.toolbar.activeTabID', JSON.stringify(id));
      }
      // Activate the associated tray.
      var $tray = this.$el.find('[data-toolbar-tray="' + name + '"].toolbar-tray');
      if ($tray.length) {
        $tray.addClass('active');
        this.model.set('activeTray', $tray.get(0));
      }
      else {
        // There is no active tray.
        this.model.set('activeTray', null);
      }
    }
    else {
      // There is no active tray.
      this.model.set('activeTray', null);
      localStorage.removeItem('Drupal.toolbar.activeTabID');
    }
  },

  /**
   * Update the attributes of the toolbar bar element.
   */
  updateBarAttributes: function () {
    var isOriented = this.model.get('isOriented');
    if (isOriented) {
      this.$el.find('.toolbar-bar').attr('data-offset-top', '');
    }
    else {
      this.$el.find('.toolbar-bar').removeAttr('data-offset-top');
    }
    // Toggle between a basic vertical view and a more sophisticated
    // horizontal and vertical display of the toolbar bar and trays.
    this.$el.toggleClass('toolbar-oriented', isOriented);
  },

  /**
   * Updates the orientation of the active tray if necessary.
   */
  updateTrayOrientation: function () {
    var orientation = this.model.get('orientation');
    // The antiOrientation is used to render the view of action buttons like
    // the tray orientation toggle.
    var antiOrientation = (orientation === 'vertical') ? 'horizontal' : 'vertical';
    // Update the orientation of the trays.
    var $trays = this.$el.find('.toolbar-tray')
      .removeClass('toolbar-tray-horizontal toolbar-tray-vertical')
      .addClass('toolbar-tray-' + orientation);

    // Update the tray orientation toggle button.
    var iconClass = 'toolbar-icon-toggle-' + orientation;
    var iconAntiClass = 'toolbar-icon-toggle-' + antiOrientation;
    var $orientationToggle = this.$el.find('.toolbar-toggle-orientation')
      .toggle(this.model.get('isTrayToggleVisible'));
    $orientationToggle.find('button')
      .val(antiOrientation)
      .text(this.strings[antiOrientation])
      .removeClass(iconClass)
      .addClass(iconAntiClass);

    // Update data offset attributes for the trays.
    var dir = document.documentElement.dir;
    var edge = (dir === 'rtl') ? 'right' : 'left';
    // Remove data-offset attributes from the trays so they can be refreshed.
    $trays.removeAttr('data-offset-left data-offset-right data-offset-top');
    // If an active vertical tray exists, mark it as an offset element.
    $trays.filter('.toolbar-tray-vertical.active').attr('data-offset-' + edge, '');
    // If an active horizontal tray exists, mark it as an offset element.
    $trays.filter('.toolbar-tray-horizontal.active').attr('data-offset-top', '');
  },

  /**
   * Sets the tops of the trays so that they align with the bottom of the bar.
   */
  adjustPlacement: function () {
    var $trays = this.$el.find('.toolbar-tray');
    if (!this.model.get('isOriented')) {
      $trays.css('padding-top', 0);
      $trays.removeClass('toolbar-tray-horizontal').addClass('toolbar-tray-vertical');
    }
    else {
      // The toolbar container is invisible. Its placement is used to
      // determine the container for the trays.
      $trays.css('padding-top', this.$el.find('.toolbar-bar').outerHeight());
    }
  },

  /**
   * Calls the endpoint URI that will return rendered subtrees with JSONP.
   *
   * The rendered admin menu subtrees HTML is cached on the client in
   * localStorage until the cache of the admin menu subtrees on the server-
   * side is invalidated. The subtreesHash is stored in localStorage as well
   * and compared to the subtreesHash in drupalSettings to determine when the
   * admin menu subtrees cache has been invalidated.
   */
  loadSubtrees: function () {
    var $activeTab = $(this.model.get('activeTab'));
    var orientation = this.model.get('orientation');
    // Only load and render the admin menu subtrees if:
    //   (1) They have not been loaded yet.
    //   (2) The active tab is the administration menu tab, indicated by the
    //       presence of the data-drupal-subtrees attribute.
    //   (3) The orientation of the tray is vertical.
    if (!this.model.get('areSubtreesLoaded') &amp;&amp; $activeTab.data('drupal-subtrees') !== undefined &amp;&amp; orientation === 'vertical') {
      var subtreesHash = drupalSettings.toolbar.subtreesHash;
      var endpoint = Drupal.url('toolbar/subtrees/' + subtreesHash);
      var cachedSubtreesHash = localStorage.getItem('Drupal.toolbar.subtreesHash');
      var cachedSubtrees = JSON.parse(localStorage.getItem('Drupal.toolbar.subtrees'));
      var isVertical = this.model.get('orientation') === 'vertical';
      // If we have the subtrees in localStorage and the subtree hash has not
      // changed, then use the cached data.
      if (isVertical &amp;&amp; subtreesHash === cachedSubtreesHash &amp;&amp; cachedSubtrees) {
        Drupal.toolbar.setSubtrees.resolve(cachedSubtrees);
      }
      // Only make the call to get the subtrees if the orientation of the
      // toolbar is vertical.
      else if (isVertical) {
        // Remove the cached menu information.
        localStorage.removeItem('Drupal.toolbar.subtreesHash');
        localStorage.removeItem('Drupal.toolbar.subtrees');
        // The response from the server will call the resolve method of the
        // Drupal.toolbar.setSubtrees Promise.
        $.ajax(endpoint);
        // Cache the hash for the subtrees locally.
        localStorage.setItem('Drupal.toolbar.subtreesHash', subtreesHash);
      }
    }
  }
});

}(jQuery, Drupal, drupalSettings, Backbone));
</code>
</pre>
              </article>
            </section>
          </div>
        </div>
        <nav class="pure-u-1-5">
          <div class="box">
            <h2>
              <a href="index.html">Index</a>
            </h2>
            <h3>
              Classes
            </h3>
            <ul>
              <li>
                <a href="Drupal.ajax.html">Drupal.ajax</a>
              </li>
              <li>
                <a href="Drupal.AjaxCommands.html">Drupal.AjaxCommands</a>
              </li>
              <li>
                <a href="Drupal.AjaxError.html">Drupal.AjaxError</a>
              </li>
              <li>
                <a href="Drupal.CollapsibleDetails.html">Drupal.CollapsibleDetails</a>
              </li>
              <li>
                <a href="Drupal.contextual.AuralView.html">Drupal.contextual.AuralView</a>
              </li>
              <li>
                <a href="Drupal.contextual.KeyboardView.html">Drupal.contextual.KeyboardView</a>
              </li>
              <li>
                <a href="Drupal.contextual.RegionView.html">Drupal.contextual.RegionView</a>
              </li>
              <li>
                <a href="Drupal.contextual.StateModel.html">Drupal.contextual.StateModel</a>
              </li>
              <li>
                <a href="Drupal.contextual.VisualView.html">Drupal.contextual.VisualView</a>
              </li>
              <li>
                <a href="Drupal.contextualToolbar.Model.html">Drupal.contextualToolbar.Model</a>
              </li>
              <li>
                <a href="Drupal.contextualToolbar.VisualView.html">Drupal.contextualToolbar.VisualView</a>
              </li>
              <li>
                <a href="Drupal.DropButton.html">Drupal.DropButton</a>
              </li>
              <li>
                <a href="Drupal.edit.AppModel.html">Drupal.edit.AppModel</a>
              </li>
              <li>
                <a href="Drupal.edit.AppView.html">Drupal.edit.AppView</a>
              </li>
              <li>
                <a href="Drupal.edit.BaseModel.html">Drupal.edit.BaseModel</a>
              </li>
              <li>
                <a href="Drupal.edit.ContextualLinkView.html">Drupal.edit.ContextualLinkView</a>
              </li>
              <li>
                <a href="Drupal.edit.EditorModel.html">Drupal.edit.EditorModel</a>
              </li>
              <li>
                <a href="Drupal.edit.editors.editor.html">Drupal.edit.editors.editor</a>
              </li>
              <li>
                <a href="Drupal.edit.editors.form.html">Drupal.edit.editors.form</a>
              </li>
              <li>
                <a href="Drupal.edit.editors.plain_text.html">Drupal.edit.editors.plain_text</a>
              </li>
              <li>
                <a href="Drupal.edit.EditorView.html">Drupal.edit.EditorView</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityCollection.html">Drupal.edit.EntityCollection</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityDecorationView.html">Drupal.edit.EntityDecorationView</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityModel.html">Drupal.edit.EntityModel</a>
              </li>
              <li>
                <a href="Drupal.edit.EntityToolbarView.html">Drupal.edit.EntityToolbarView</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldCollection.html">Drupal.edit.FieldCollection</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldDecorationView.html">Drupal.edit.FieldDecorationView</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldModel.html">Drupal.edit.FieldModel</a>
              </li>
              <li>
                <a href="Drupal.edit.FieldToolbarView.html">Drupal.edit.FieldToolbarView</a>
              </li>
              <li>
                <a href="Drupal.EditorFeature.html">Drupal.EditorFeature</a>
              </li>
              <li>
                <a href="Drupal.EditorFeatureHTMLRule.html">Drupal.EditorFeatureHTMLRule</a>
              </li>
              <li>
                <a href="Drupal.fieldUIDisplayOverview.field.html">Drupal.fieldUIDisplayOverview.field</a>
              </li>
              <li>
                <a href="Drupal.FilterHTMLRule.html">Drupal.FilterHTMLRule</a>
              </li>
              <li>
                <a href="Drupal.FilterStatus.html">Drupal.FilterStatus</a>
              </li>
              <li>
                <a href="Drupal.ProgressBar.html">Drupal.ProgressBar</a>
              </li>
              <li>
                <a href="Drupal.states.Dependent.html">Drupal.states.Dependent</a>
              </li>
              <li>
                <a href="Drupal.states.State.html">Drupal.states.State</a>
              </li>
              <li>
                <a href="Drupal.states.Trigger.html">Drupal.states.Trigger</a>
              </li>
              <li>
                <a href="Drupal.tableDrag.html">Drupal.tableDrag</a>
              </li>
              <li>
                <a href="Drupal.TableHeader.html">Drupal.TableHeader</a>
              </li>
              <li>
                <a href="Drupal.TableResponsive.html">Drupal.TableResponsive</a>
              </li>
              <li>
                <a href="Drupal.toolbar.BodyVisualView.html">Drupal.toolbar.BodyVisualView</a>
              </li>
              <li>
                <a href="Drupal.toolbar.MenuModel.html">Drupal.toolbar.MenuModel</a>
              </li>
              <li>
                <a href="Drupal.toolbar.MenuVisualView.html">Drupal.toolbar.MenuVisualView</a>
              </li>
              <li>
                <a href="Drupal.toolbar.ToolbarAuralView.html">Drupal.toolbar.ToolbarAuralView</a>
              </li>
              <li>
                <a href="Drupal.toolbar.ToolbarModel.html">Drupal.toolbar.ToolbarModel</a>
              </li>
              <li>
                <a href="Drupal.toolbar.ToolbarVisualView.html">Drupal.toolbar.ToolbarVisualView</a>
              </li>
              <li>
                <a href="Drupal.tour.models.StateModel.html">Drupal.tour.models.StateModel</a>
              </li>
              <li>
                <a href="Drupal.tour.views.ToggleTourView.html">Drupal.tour.views.ToggleTourView</a>
              </li>
              <li>
                <a href="Drupal.verticalTab.html">Drupal.verticalTab</a>
              </li>
              <li>
                <a href="Drupal.views.ajaxView.html">Drupal.views.ajaxView</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.AddItemForm.html">Drupal.viewsUi.AddItemForm</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.Checkboxifier.html">Drupal.viewsUi.Checkboxifier</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.FormFieldFiller.html">Drupal.viewsUi.FormFieldFiller</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.OptionsSearch.html">Drupal.viewsUi.OptionsSearch</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.RearrangeFilterHandler.html">Drupal.viewsUi.RearrangeFilterHandler</a>
              </li>
            </ul>
            <h3>
              Events
            </h3>
            <ul>
              <li>
                <a href="global.html#event:drupalViewportOffsetChange">event:drupalViewportOffsetChange</a>
              </li>
              <li>
                <a href="global.html#event:formUpdated">event:formUpdated</a>
              </li>
              <li>
                <a href="global.html#event:summaryUpdated">event:summaryUpdated</a>
              </li>
            </ul>
            <h3>
              Namespaces
            </h3>
            <ul>
              <li>
                <a href="Drupal.html" class="root">Drupal</a>
              </li>
              <li>
                <a href="Drupal.behaviors.html">Drupal.behaviors</a>
              </li>
              <li>
                <a href="Drupal.color.html">Drupal.color</a>
              </li>
              <li>
                <a href="Drupal.contextual.html">Drupal.contextual</a>
              </li>
              <li>
                <a href="Drupal.contextualToolbar.html">Drupal.contextualToolbar</a>
              </li>
              <li>
                <a href="Drupal.edit.html">Drupal.edit</a>
              </li>
              <li>
                <a href="Drupal.edit.metadata.html">Drupal.edit.metadata</a>
              </li>
              <li>
                <a href="Drupal.edit.util.html">Drupal.edit.util</a>
              </li>
              <li>
                <a href="Drupal.edit.util.constants.html">Drupal.edit.util.constants</a>
              </li>
              <li>
                <a href="Drupal.edit.util.form.html">Drupal.edit.util.form</a>
              </li>
              <li>
                <a href="Drupal.editorConfiguration.html">Drupal.editorConfiguration</a>
              </li>
              <li>
                <a href="Drupal.editors.html">Drupal.editors</a>
              </li>
              <li>
                <a href="Drupal.fieldUIDisplayOverview.html">Drupal.fieldUIDisplayOverview</a>
              </li>
              <li>
                <a href="Drupal.fieldUIOverview.html">Drupal.fieldUIOverview</a>
              </li>
              <li>
                <a href="Drupal.file.html">Drupal.file</a>
              </li>
              <li>
                <a href="Drupal.filterConfiguration.html">Drupal.filterConfiguration</a>
              </li>
              <li>
                <a href="Drupal.filterConfiguration.liveSettingParsers.html">Drupal.filterConfiguration.liveSettingParsers</a>
              </li>
              <li>
                <a href="Drupal.history.html">Drupal.history</a>
              </li>
              <li>
                <a href="Drupal.states.html">Drupal.states</a>
              </li>
              <li>
                <a href="Drupal.states.Trigger.states.html">Drupal.states.Trigger.states</a>
              </li>
              <li>
                <a href="Drupal.theme.html">Drupal.theme</a>
              </li>
              <li>
                <a href="Drupal.toolbar.html">Drupal.toolbar</a>
              </li>
              <li>
                <a href="Drupal.tour.html">Drupal.tour</a>
              </li>
              <li>
                <a href="Drupal.tour.models.html">Drupal.tour.models</a>
              </li>
              <li>
                <a href="Drupal.tour.views.html">Drupal.tour.views</a>
              </li>
              <li>
                <a href="Drupal.Views.html">Drupal.Views</a>
              </li>
              <li>
                <a href="Drupal.views_.html">Drupal.views</a>
              </li>
              <li>
                <a href="Drupal.viewsUi.html">Drupal.viewsUi</a>
              </li>
            </ul>
            <h3>
              Global
            </h3>
            <ul>
              <li>
                <a href="global.html#drupalSettings" class="root">drupalSettings</a>
              </li>
              <li>
                <a href="global.html#matchMedia" class="root">matchMedia</a>
              </li>
            </ul>
            <p>
              <strong>For more information about this documentation please see <a href="#todo">Issue #XXX</a>.</strong>
            </p>
          </div>
        </nav>
      </div>
    </div><script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47079344-1', 'theodoreb.net');
    ga('send', 'pageview');
    </script><script type="text/javascript">
prettyPrint();
    </script><script src="scripts/linenumber.js" type="text/javascript">
</script>
  </body>
</html>
